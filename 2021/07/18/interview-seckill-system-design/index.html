<!-- build time:Mon Jul 19 2021 00:45:36 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="系统设计,秒杀系统,"><link rel="alternate" href="/atom.xml" title="以写作调身心" type="application/atom+xml"><meta name="description" content="秒杀系统架构设计都有哪些关键点秒杀其实主要解决两个问题，一个是并发读，一个是并发写。秒杀的整体架构可以概括为“稳、准、快”几个关键字。所谓“稳”，就是整个系统架构要满足高可用，流量符合预期时肯定要稳定，就是超出预期时也同样不能掉链子，你要保证秒杀活动顺利完成，即秒杀商品顺利地卖出去，这个是最基本的前提。所谓“准”，就是秒杀 10 台 iPhone，那就只能成交 10 台，多一台少一台都不行。一旦库"><meta name="keywords" content="系统设计,秒杀系统"><meta property="og:type" content="article"><meta property="og:title" content="如何设计一个秒杀系统"><meta property="og:url" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;index.html"><meta property="og:site_name" content="以写作调身心"><meta property="og:description" content="秒杀系统架构设计都有哪些关键点秒杀其实主要解决两个问题，一个是并发读，一个是并发写。秒杀的整体架构可以概括为“稳、准、快”几个关键字。所谓“稳”，就是整个系统架构要满足高可用，流量符合预期时肯定要稳定，就是超出预期时也同样不能掉链子，你要保证秒杀活动顺利完成，即秒杀商品顺利地卖出去，这个是最基本的前提。所谓“准”，就是秒杀 10 台 iPhone，那就只能成交 10 台，多一台少一台都不行。一旦库"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9D%A5%E7%BC%93%E5%86%B2%E7%9E%AC%E6%97%B6%E6%B5%81%E9%87%8F.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E7%A7%92%E6%9D%80%E7%AD%94%E9%A2%98.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E7%AD%94%E9%A2%98%E7%9A%84%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E5%88%86%E5%B1%82%E8%BF%87%E6%BB%A4.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E9%AB%98%E5%8F%AF%E7%94%A8%E5%BB%BA%E8%AE%BE.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E5%BC%80%E5%85%B3%E7%B3%BB%E7%BB%9F.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E9%99%90%E6%B5%81%E7%B3%BB%E7%BB%9F.png"><meta property="og:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E5%A4%B1%E6%95%88%E4%B8%AD%E5%BF%83.png"><meta property="og:updated_time" content="2021-07-18T14:16:13.634Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https:&#x2F;&#x2F;octopuslian.github.io&#x2F;2021&#x2F;07&#x2F;18&#x2F;interview-seckill-system-design&#x2F;%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9D%A5%E7%BC%93%E5%86%B2%E7%9E%AC%E6%97%B6%E6%B5%81%E9%87%8F.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://octopuslian.github.io/2021/07/18/interview-seckill-system-design/"><title>如何设计一个秒杀系统 | 以写作调身心</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">以写作调身心</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">熟能生巧，勤能补拙；念念不忘，必有回响。</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>归档</a></li><li class="menu-item menu-item-reward"><a href="/reward" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>打赏者记录</a></li><li class="menu-item menu-item-wishlist"><a href="/wishlist" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>愿望清单</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://octopuslian.github.io/2021/07/18/interview-seckill-system-design/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Neo Zhang"><meta itemprop="description" content=""><meta itemprop="image" content="/images/neozhang.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="以写作调身心"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">如何设计一个秒杀系统</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-18T22:09:53+08:00">2021-07-18 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/System-Design/" itemprop="url" rel="index"><span itemprop="name">System-Design</span> </a></span></span><span class="post-meta-divider">|</span> <span class="page-pv"><i class="fa fa-file-o"></i> <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">10k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">34</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="秒杀系统架构设计都有哪些关键点"><a href="#秒杀系统架构设计都有哪些关键点" class="headerlink" title="秒杀系统架构设计都有哪些关键点"></a>秒杀系统架构设计都有哪些关键点</h1><p><strong>秒杀其实主要解决两个问题，一个是并发读，一个是并发写。</strong></p><p>秒杀的整体架构可以概括为“稳、准、快”几个关键字。</p><p>所谓“稳”，就是整个系统架构要满足高可用，流量符合预期时肯定要稳定，就是超出预期时也同样不能掉链子，你要保证秒杀活动顺利完成，即秒杀商品顺利地卖出去，这个是最基本的前提。</p><p>所谓“准”，就是秒杀 10 台 iPhone，那就只能成交 10 台，多一台少一台都不行。一旦库存不对，那平台就要承担损失，所以“准”就是要求保证数据的一致性。</p><p>所谓“快”，“快”其实很好理解，它就是说系统的性能要足够高，否则你怎么支撑这么大的流量呢？不光是服务端要做极致的性能优化，而且在整个请求链路上都要做协同的优化，每个地方快一点，整个系统就完美了。</p><h1 id="设计秒杀系统时应该注意的5个架构原则"><a href="#设计秒杀系统时应该注意的5个架构原则" class="headerlink" title="设计秒杀系统时应该注意的5个架构原则"></a>设计秒杀系统时应该注意的5个架构原则</h1><p><strong>秒杀系统本质上就是一个满足大并发、高性能和高可用的分布式系统。</strong></p><h2 id="架构原则1-数据要尽量少"><a href="#架构原则1-数据要尽量少" class="headerlink" title="架构原则1. 数据要尽量少"></a>架构原则1. 数据要尽量少</h2><p>所谓“数据要尽量少”，首先是指用户请求的数据能少就少。请求的数据包括上传给系统的数据和系统返回给用户的数据（通常就是网页）。</p><h3 id="为什么“数据要尽量少”呢？"><a href="#为什么“数据要尽量少”呢？" class="headerlink" title="为什么“数据要尽量少”呢？"></a>为什么“数据要尽量少”呢？</h3><p>因为首先这些数据在网络上传输需要时间，其次不管是请求数据还是返回数据都需要服务器做处理，而服务器在写网络时通常都要做压缩和字符编码，这些都非常消耗 CPU，所以减少传输的数据量可以显著减少 CPU 的使用。例如，我们可以简化秒杀页面的大小，去掉不必要的页面装修效果，等等。</p><p>其次，“数据要尽量少”还要求系统依赖的数据能少就少，包括系统完成某些业务逻辑需要读取和保存的数据，这些数据一般是和后台服务以及数据库打交道的。调用其他服务会涉及数据的序列化和反序列化，而这也是 CPU 的一大杀手，同样也会增加延时。而且，数据库本身也容易成为一个瓶颈，所以和数据库打交道越少越好，数据越简单、越小则越好。</p><h2 id="架构原则2-请求数要尽量少"><a href="#架构原则2-请求数要尽量少" class="headerlink" title="架构原则2. 请求数要尽量少"></a>架构原则2. 请求数要尽量少</h2><p>用户请求的页面返回后，浏览器渲染这个页面还要包含其他的额外请求，比如说，这个页面依赖的 CSS/JavaScript、图片，以及 Ajax 请求等等都定义为“额外请求”，这些额外请求应该尽量少。因为浏览器每发出一个请求都多少会有一些消耗，例如建立连接要做三次握手，有的时候有页面依赖或者连接数限制，一些请求（例如 JavaScript）还需要串行加载等。另外，如果不同请求的域名不一样的话，还涉及这些域名的 DNS 解析，可能会耗时更久。所以你要记住的是，减少请求数可以显著减少以上这些因素导致的资源消耗。</p><h2 id="架构原则3-路径要尽量短"><a href="#架构原则3-路径要尽量短" class="headerlink" title="架构原则3. 路径要尽量短"></a>架构原则3. 路径要尽量短</h2><p>所谓“路径”，就是用户发出请求到返回数据这个过程中，需求经过的中间的节点数。</p><p>通常，这些节点可以表示为一个系统或者一个新的 Socket 连接（比如代理服务器只是创建一个新的 Socket 连接来转发请求）。每经过一个节点，一般都会产生一个新的 Socket 连接。</p><p>然而，每增加一个连接都会增加新的不确定性。从概率统计上来说，假如一次请求经过 5个节点，每个节点的可用性是 99.9% 的话，那么整个请求的可用性是：99.9% 的 5 次方，约等于 99.5%。</p><p>所以缩短请求路径不仅可以增加可用性，同样可以有效提升性能（减少中间节点可以减少数据的序列化与反序列化），并减少延时（可以减少网络传输耗时)。</p><h2 id="架构原则4-依赖要尽量少"><a href="#架构原则4-依赖要尽量少" class="headerlink" title="架构原则4. 依赖要尽量少"></a>架构原则4. 依赖要尽量少</h2><p>所谓依赖，指的是要完成一次用户请求必须依赖的系统或者服务，这里的依赖指的是强依赖。</p><p>举个例子，比如说你要展示秒杀页面，而这个页面必须强依赖商品信息、用户信息，还有其他如优惠券、成交列表等这些对秒杀不是非要不可的信息（弱依赖），这些弱依赖在紧急情况下就可以去掉。</p><p>要减少依赖，我们可以给系统进行分级，比如 0 级系统、1 级系统、2 级系统、3 级系统，0 级系统如果是最重要的系统，那么 0 级系统强依赖的系统也同样是最重要的系统，以此类推。</p><h2 id="架构原则5-不要有单点"><a href="#架构原则5-不要有单点" class="headerlink" title="架构原则5. 不要有单点"></a>架构原则5. 不要有单点</h2><p>系统中的单点可以说是系统架构上的一个大忌，因为单点意味着没有备份，风险不可控，我们设计分布式系统最重要的原则就是“消除单点”。</p><p>那如何避免单点呢？我认为关键点是避免将服务的状态和机器绑定，即把服务无状态化，这样服务就可以在机器中随意移动。</p><p>如何那把服务的状态和机器解耦呢？这里也有很多实现方式。例如把和机器相关的配置动态化，这些参数可以通过配置中心来动态推送，在服务启动时动态拉取下来，我们在这些配置中心设置一些规则来方便地改变这些映射关系。</p><p>应用无状态化是有效避免单点的一种方式，但是像存储服务本身很难无状态化，因为数据要存储在磁盘上，本身就要和机器绑定，那么这种场景一般要通过冗余多个备份的方式来解决单点问题。</p><h1 id="如何才能做好动静分离？有哪些方案可选？"><a href="#如何才能做好动静分离？有哪些方案可选？" class="headerlink" title="如何才能做好动静分离？有哪些方案可选？"></a>如何才能做好动静分离？有哪些方案可选？</h1><h2 id="何为动静数据"><a href="#何为动静数据" class="headerlink" title="何为动静数据"></a>何为动静数据</h2><p><strong>动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和URL、浏览者、时间、地域相关，以及是否含有 Cookie 等私密数据。</strong></p><h3 id="怎样对静态数据做缓存"><a href="#怎样对静态数据做缓存" class="headerlink" title="怎样对静态数据做缓存"></a>怎样对静态数据做缓存</h3><ul><li>第一，你应该把静态数据缓存到离用户最近的地方。</li><li>第二，静态化改造就是要直接缓存 HTTP 连接。</li><li>第三，让谁来缓存静态数据也很重要。</li></ul><h2 id="如何做动静分离的改造"><a href="#如何做动静分离的改造" class="headerlink" title="如何做动静分离的改造"></a>如何做动静分离的改造</h2><ul><li><ol><li>URL 唯一化。</li></ol></li><li><ol start="2"><li>分离浏览者相关的因素。</li></ol></li><li><ol start="3"><li>分离时间因素。</li></ol></li><li><ol start="4"><li>异步化地域因素。</li></ol></li><li><ol start="5"><li>去掉 Cookie。</li></ol></li></ul><h2 id="动静分离的几种架构方案"><a href="#动静分离的几种架构方案" class="headerlink" title="动静分离的几种架构方案"></a>动静分离的几种架构方案</h2><h3 id="方案-1：实体机单机部署"><a href="#方案-1：实体机单机部署" class="headerlink" title="方案 1：实体机单机部署"></a>方案 1：实体机单机部署</h3><h3 id="方案-2：统一-Cache-层"><a href="#方案-2：统一-Cache-层" class="headerlink" title="方案 2：统一 Cache 层"></a>方案 2：统一 Cache 层</h3><h3 id="方案-3：上-CDN"><a href="#方案-3：上-CDN" class="headerlink" title="方案 3：上 CDN"></a>方案 3：上 CDN</h3><h1 id="二八原则：有针对性地处理好系统的“热点数据”"><a href="#二八原则：有针对性地处理好系统的“热点数据”" class="headerlink" title="二八原则：有针对性地处理好系统的“热点数据”"></a>二八原则：有针对性地处理好系统的“热点数据”</h1><h2 id="为什么要关注热点"><a href="#为什么要关注热点" class="headerlink" title="为什么要关注热点"></a>为什么要关注热点</h2><p>首先，热点请求会大量占用服务器处理资源，虽然这个热点可能只占请求总量的亿分之一，然而却可能抢占 90% 的服务器资源，如果这个热点请求还是没有价值的无效请求，那么对系统资源来说完全是浪费。</p><p>其次，即使这些热点是有效的请求，我们也要识别出来做针对性的优化，从而用更低的代价来支撑这些热点请求。</p><h2 id="什么是“热点”"><a href="#什么是“热点”" class="headerlink" title="什么是“热点”"></a>什么是“热点”</h2><p>热点分为热点操作和热点数据。</p><p>所谓“热点操作”，例如大量的刷新页面、大量的添加购物车、双十一零点大量的下单等都属于此类操作。对系统来说，这些操作可以抽象为“读请求”和“写请求”，这两种热点请求的处理方式大相径庭，读请求的优化空间要大一些，而写请求的瓶颈一般都在存储层，优化的思路就是根据 CAP 理论做平衡。</p><p>而“热点数据”就是用户的热点请求对应的数据。而热点数据又分为“静态热点数据”和“动态热点数据”。</p><ul><li><p>所谓“静态热点数据”，就是能够提前预测的热点数据。例如，我们可以通过卖家报名的方式提前筛选出来，通过报名系统对这些热点商品进行打标。另外，我们还可以通过大数据分析来提前发现热点商品，比如我们分析历史成交记录、用户的购物车记录，来发现哪些商品可能更热门、更好卖，这些都是可以提前分析出来的热点。</p></li><li><p>所谓“动态热点数据”，就是不能被提前预测到的，系统在运行过程中临时产生的热点。例如，卖家在抖音上做了广告，然后商品一下就火了，导致它在短时间内被大量购买。</p></li></ul><h2 id="发现热点数据"><a href="#发现热点数据" class="headerlink" title="发现热点数据"></a>发现热点数据</h2><h2 id="处理热点数据"><a href="#处理热点数据" class="headerlink" title="处理热点数据"></a>处理热点数据</h2><p>处理热点数据通常有几种思路：一是优化，二是限制，三是隔离。</p><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>优化热点数据最有效的办法就是缓存热点数据，如果热点数据做了动静分离，那么可以长期缓存静态数据。但是，缓存热点数据更多的是“临时”缓存，即不管是静态数据还是动态数据，都用一个队列短暂地缓存数秒钟，由于队列长度有限，可以采用LRU 淘汰算法替换。</p><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><p>限制更多的是一种保护机制，限制的办法也有很多，例如对被访问商品的ID 做一致性 Hash，然后根据 Hash 做分桶，每个分桶设置一个处理队列，这样可以把热点商品限制在一个请求队列里，防止因某些热点商品占用太多的服务器资源，而使其他请求始终得不到服务器的处理资源。</p><h3 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h3><p>秒杀系统设计的第一个原则就是将这种热点数据隔离出来，不要让 1%的请求影响到另外的 99%，隔离出来后也更方便对这 1% 的请求做针对性的优化。</p><p>具体到“秒杀”业务，我们可以在以下几个层次实现隔离。</p><ul><li><ol><li>业务隔离。把秒杀做成一种营销活动，卖家要参加秒杀这种营销活动需要单独报名，从技术上来说，卖家报名后对我们来说就有了已知热点，因此可以提前做好预热。</li></ol></li><li><ol start="2"><li>系统隔离。系统隔离更多的是运行时的隔离，可以通过分组部署的方式和另外 99% 分开。秒杀可以申请单独的域名，目的也是让请求落到不同的集群中。</li></ol></li><li><ol start="3"><li>数据隔离。秒杀所调用的数据大部分都是热点数据，比如会启用单独的 Cache 集群或者MySQL 数据库来放热点数据，目的也是不想 0.01% 的数据有机会影响 99.99% 数据。</li></ol></li></ul><h1 id="流量削峰这事应该怎么做？"><a href="#流量削峰这事应该怎么做？" class="headerlink" title="流量削峰这事应该怎么做？"></a>流量削峰这事应该怎么做？</h1><h2 id="为什么要削峰"><a href="#为什么要削峰" class="headerlink" title="为什么要削峰"></a>为什么要削峰</h2><p>削峰的存在，一是可以让服务端处理变得更加平稳，二是可以节省服务器的资源成本。针对秒杀这一场景，削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，它遵从“请求数要尽量少”的原则。</p><p>流量削峰的一些操作思路：排队、答题、分层过滤，这三个都是无损（即不会损失用户的发出请求）的实现方案。</p><h2 id="排队"><a href="#排队" class="headerlink" title="排队"></a>排队</h2><p>要对流量进行削峰，最容易想到的解决方案就是用消息队列来缓冲瞬时流量，把同步的直接调用转换成异步的间接推送，中间通过一个队列在一端承接瞬时的流量洪峰，在另一端平滑地将消息推送出去。在这里，消息队列就像“水库”一样， 拦蓄上游的洪水，削减进入下游河道的洪峰流量，从而达到减免洪水灾害的目的。</p><p>用消息队列来缓冲瞬时流量的方案，如下图所示：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9D%A5%E7%BC%93%E5%86%B2%E7%9E%AC%E6%97%B6%E6%B5%81%E9%87%8F.png" alt></p><p>但是，如果流量峰值持续一段时间达到了消息队列的处理上限，例如本机的消息积压达到了存储空间的上限，消息队列同样也会被压垮，这样虽然保护了下游的系统，但是和直接把请求丢弃也没多大的区别。就像遇到洪水爆发时，即使是有水库恐怕也无济于事。</p><p>除了消息队列，类似的排队方式还有很多，例如：</p><ol><li>利用线程池加锁等待也是一种常用的排队方式；</li><li>先进先出、先进后出等常用的内存排队算法的实现方式；</li><li>把请求序列化到文件中，然后再顺序地读文件（例如基于 MySQL binlog 的同步机制）来恢复请求等方式。</li></ol><h2 id="答题"><a href="#答题" class="headerlink" title="答题"></a>答题</h2><p>主要是为了增加购买的复杂度，从而达到两个目的:<br>第一个目的是防止部分买家使用秒杀器在参加秒杀时作弊。<br>第二个目的其实就是延缓请求，起到对请求流量进行削峰的作用，从而让系统能够更好地支持瞬时的流量高峰。</p><p>秒杀答题的设计思路：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E7%A7%92%E6%9D%80%E7%AD%94%E9%A2%98.png" alt></p><p>如上图所示，整个秒杀答题的逻辑主要分为 3 部分：</p><ul><li><ol><li>题库生成模块，这个部分主要就是生成一个个问题和答案，其实题目和答案本身并不需要很复杂，重要的是能够防止由机器来算出结果，即防止秒杀器来答题。</li></ol></li><li><ol start="2"><li>题库的推送模块，用于在秒杀答题前，把题目提前推送给详情系统和交易系统。题库的推送主要是为了保证每次用户请求的题目是唯一的，目的也是防止答题作弊。</li></ol></li><li><ol start="3"><li>题目的图片生成模块，用于把题目生成为图片格式，并且在图片里增加一些干扰因素。这也同样是为防止机器直接来答题，它要求只有人才能理解题目本身的含义。这里还要注意一点，由于答题时网络比较拥挤，我们应该把题目的图片提前推送到 CDN 上并且要进行预热，不然的话当用户真正请求题目时，图片可能加载比较慢，从而影响答题的体验。</li></ol></li></ul><p>真正答题的逻辑比较简单，可以理解为：<strong>当用户提交的答案和题目对应的答案做比较，如果通过了就继续进行下一步的下单逻辑，否则就失败。我们可以把问题和答案用下面这样的key 来进行 MD5 加密</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">问题 key：userId+itemId+question_Id+time+PK</span><br><span class="line">答案 key：userId+itemId+answer+PK</span><br></pre></td></tr></table></figure><p>验证的逻辑如下图所示：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E7%AD%94%E9%A2%98%E7%9A%84%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91.png" alt></p><p>注意，这里面的验证逻辑，除了验证问题的答案以外，还包括用户本身身份的验证，例如是否已经登录、用户的Cookie 是否完整、用户是否重复频繁提交等。</p><p>除了做正确性验证，我们还可以对提交答案的时间做些限制，例如从开始答题到接受答案要超过 1s，因为小于 1s 是人为操作的可能性很小，这样也能防止机器答题的情况。</p><h2 id="分层过滤"><a href="#分层过滤" class="headerlink" title="分层过滤"></a>分层过滤</h2><p>分层过滤其实就是采用“漏斗”式设计来处理请求的，如下图所示：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E5%88%86%E5%B1%82%E8%BF%87%E6%BB%A4.png" alt></p><p>假如请求分别经过 CDN、前台读系统（如商品详情系统）、后台系统（如交易系统）和数据库这几层，那么：</p><ul><li>大部分数据和流量在用户浏览器或者 CDN 上获取，这一层可以拦截大部分数据的读取；</li><li>经过第二层（即前台系统）时数据（包括强一致性的数据）尽量得走 Cache，过滤一些无效的请求；</li><li>再到第三层后台系统，主要做数据的二次检验，对系统做好保护和限流，这样数据量和请求就进一步减少；</li><li>最后在数据层完成数据的强一致性校验。</li></ul><p>分层过滤的核心思想是：<strong>在不同的层次尽可能地过滤掉无效请求，让“漏斗”最末端的才是有效请求。</strong></p><p>分层校验的基本原则是：</p><ul><li><ol><li>将动态请求的读数据缓存（Cache）在 Web 端，过滤掉无效的数据读；</li></ol></li><li><ol start="2"><li>对读数据不做强一致性校验，减少因为一致性校验产生瓶颈的问题；</li></ol></li><li><ol start="3"><li>对写数据进行基于时间的合理分片，过滤掉过期的失效请求；</li></ol></li><li><ol start="4"><li>对写请求做限流保护，将超出系统承载能力的请求过滤掉；</li></ol></li><li><ol start="5"><li>对写数据进行强一致性校验，只保留最后有效的数据。</li></ol></li></ul><p>分层校验的目的是：在读系统中，尽量减少由于一致性校验带来的系统瓶颈，但是尽量将不影响性能的检查条件提前，如用户是否具有秒杀资格、商品状态是否正常、用户答题是否正确、秒杀是否已经结束、是否非法请求、营销等价物是否充足等；在写数据系统中，主要对写的数据（如“库存”）做一致性检查，最后在数据库层保证数据的最终准确性（如“库存”不能减为负数）。</p><h1 id="影响性能的因素有哪些？又该如何提高系统的性能？"><a href="#影响性能的因素有哪些？又该如何提高系统的性能？" class="headerlink" title="影响性能的因素有哪些？又该如何提高系统的性能？"></a>影响性能的因素有哪些？又该如何提高系统的性能？</h1><h2 id="影响性能的因素"><a href="#影响性能的因素" class="headerlink" title="影响性能的因素"></a>影响性能的因素</h2><h3 id="响应时间和-QPS"><a href="#响应时间和-QPS" class="headerlink" title="响应时间和 QPS"></a>响应时间和 QPS</h3><p>对于大部分的 Web 系统而言，响应时间一般都是由 CPU 执行时间和线程等待时间（比如RPC、IO 等待、Sleep、Wait 等）组成，即服务器在处理一个请求时，一部分是 CPU 本身在做运算，还有一部分是在各种等待。</p><h3 id="线程数对-QPS-的影响"><a href="#线程数对-QPS-的影响" class="headerlink" title="线程数对 QPS 的影响"></a>线程数对 QPS 的影响</h3><p>线程数 = [(线程等待时间 + 线程 CPU 时间) / 线程 CPU 时间] × CPU 数量</p><p>所以：要提升性能我们就要减少 CPU 的执行时间，另外就是要设置一个合理的并发线程数，通过这两方面来显著提升服务器的性能。</p><h2 id="如何发现瓶颈"><a href="#如何发现瓶颈" class="headerlink" title="如何发现瓶颈"></a>如何发现瓶颈</h2><p>我们定位的场景是秒杀，它的瓶颈更多地发生在 CPU 上。</p><p>那么，如何发现 CPU 的瓶颈呢？其实有很多 CPU 诊断工具可以发现 CPU 的消耗，最常用的就是 JProfiler 和 Yourkit 这两个工具，它们可以列出整个请求中每个函数的 CPU 执行时间，可以发现哪个函数消耗的 CPU 时间最多，以便你有针对性地做优化。</p><h2 id="如何优化系统"><a href="#如何优化系统" class="headerlink" title="如何优化系统"></a>如何优化系统</h2><h3 id="减少编码"><a href="#减少编码" class="headerlink" title="减少编码"></a>减少编码</h3><p>Java 的编码运行比较慢，这是 Java 的一大硬伤。在很多场景下，只要涉及字符串的操作（如输入输出操作、I/O 操作）都比较耗 CPU 资源，不管它是磁盘 I/O 还是网络 I/O，因为都需要将字符转换成字节，而这个转换必须编码。</p><p>每个字符的编码都需要查表，而这种查表的操作非常耗资源，所以减少字符到字节或者相反的转换、减少字符编码会非常有成效。减少编码就可以大大提升性能。</p><p>那么如何才能减少编码呢？<br>例如，网页输出是可以直接进行流输出的，即用resp.getOutputStream() 函数写数据，把一些静态的数据提前转化成字节，等到真正往外写的时候再直接用 OutputStream() 函数写，就可以减少静态数据的编码转换。</p><h3 id="减少序列化"><a href="#减少序列化" class="headerlink" title="减少序列化"></a>减少序列化</h3><p>序列化也是 Java 性能的一大天敌，减少 Java 中的序列化操作也能大大提升性能。又因为序列化往往是和编码同时发生的，所以减少序列化也就减少了编码。</p><p>序列化大部分是在 RPC 中发生的，因此避免或者减少 RPC 就可以减少序列化，当然当前的序列化协议也已经做了很多优化来提升性能。有一种新的方案，就是可以将多个关联性比较强的应用进行“合并部署”，而减少不同应用之间的 RPC 也可以减少序列化的消耗。</p><p>所谓“合并部署”，就是把两个原本在不同机器上的不同应用合并部署到一台机器上，当然不仅仅是部署在一台机器上，还要在同一个 Tomcat 容器中，且不能走本机的 Socket，这样才能避免序列化的产生。</p><h3 id="Java-极致优化"><a href="#Java-极致优化" class="headerlink" title="Java 极致优化"></a>Java 极致优化</h3><p>Java 和通用的 Web 服务器（如 Nginx 或 Apache 服务器）相比，在处理大并发的 HTTP请求时要弱一点，所以一般我们都会对大流量的 Web 系统做静态化改造，让大部分请求和数据直接在 Nginx 服务器或者 Web 代理服务器（如 Varnish、Squid 等）上直接返回（这样可以减少数据的序列化与反序列化），而 Java 层只需处理少量数据的动态请求。针对这些请求，我们可以使用以下手段进行优化：</p><ul><li><p>直接使用 Servlet 处理请求。避免使用传统的 MVC 框架，这样可以绕过一大堆复杂且用处不大的处理逻辑，节省 1ms 时间（具体取决于你对 MVC 框架的依赖程度）。</p></li><li><p>直接输出流数据。使用 resp.getOutputStream() 而不是 resp.getWriter() 函数，可以省掉一些不变字符数据的编码，从而提升性能；数据输出时推荐使用 JSON 而不是模板引擎（一般都是解释执行）来输出页面。</p></li></ul><h3 id="并发读优化"><a href="#并发读优化" class="headerlink" title="并发读优化"></a>并发读优化</h3><p>如何彻底解决单点的瓶颈：<br>答案是采用应用层的 LocalCache，即在秒杀系统的单机上缓存商品相关的数据。</p><p>那么，又如何缓存（Cache）数据呢？你需要划分成动态数据和静态数据分别进行处理：</p><ul><li>像商品中的“标题”和“描述”这些本身不变的数据，会在秒杀开始之前全量推送到秒杀机器上，并一直缓存到秒杀结束；</li><li>像库存这类动态数据，会采用“被动失效”的方式缓存一定时间（一般是数秒），失效后再去缓存拉取最新的数据。</li></ul><p>疑惑：像库存这种频繁更新的数据，一旦数据不一致，会不会导致超卖？<br>这就要用到前面介绍的读数据的分层校验原则了，读的场景可以允许一定的脏数据，因为这里的误判只会导致少量原本无库存的下单请求被误认为有库存，可以等到真正写数据时再保证最终的一致性，通过在数据的高可用性和一致性之间的平衡，来解决高并发的数据读取问题。</p><h1 id="秒杀系统“减库存”设计的核心逻辑"><a href="#秒杀系统“减库存”设计的核心逻辑" class="headerlink" title="秒杀系统“减库存”设计的核心逻辑"></a>秒杀系统“减库存”设计的核心逻辑</h1><h2 id="减库存有哪几种方式"><a href="#减库存有哪几种方式" class="headerlink" title="减库存有哪几种方式"></a>减库存有哪几种方式</h2><p>在正常的电商平台购物场景中，用户的实际购买过程一般分为两步：下单和付款。</p><p>那如果你是架构师，你会在哪个环节完成减库存的操作呢？总结来说，减库存操作一般有如下几个方式：</p><ul><li><p>下单减库存，即当买家下单后，在商品的总库存中减去买家购买数量。下单减库存是最简单的减库存方式，也是控制最精确的一种，下单时直接通过数据库的事务机制控制商品库存，这样一定不会出现超卖的情况。但是你要知道，有些人下完单可能并不会付款。</p></li><li><p>付款减库存，即买家下单后，并不立即减库存，而是等到有用户付款后才真正减库存，否则库存一直保留给其他买家。但因为付款时才减库存，如果并发比较高，有可能出现买家下单后付不了款的情况，因为可能商品已经被其他人买走了。</p></li><li><p>预扣库存，这种方式相对复杂一些，买家下单后，库存为其保留一定的时间（如 10 分钟），超过这个时间，库存将会自动释放，释放后其他买家就可以继续购买。在买家付款前，系统会校验该订单的库存是否还有保留：如果没有保留，则再次尝试预扣；如果库存不足（也就是预扣失败）则不允许继续付款；如果预扣成功，则完成付款并实际地减去库存。</p></li></ul><h2 id="减库存可能存在的问题"><a href="#减库存可能存在的问题" class="headerlink" title="减库存可能存在的问题"></a>减库存可能存在的问题</h2><h2 id="大型秒杀中如何减库存？"><a href="#大型秒杀中如何减库存？" class="headerlink" title="大型秒杀中如何减库存？"></a>大型秒杀中如何减库存？</h2><p>目前来看，业务系统中最常见的就是预扣库存方案，像你在买机票、买电影票时，下单后一般都有个“有效付款时间”，超过这个时间订单自动释放，这都是典型的预扣库存方案。</p><p>由于参加秒杀的商品，一般都是“抢到就是赚到”，所以成功下单后却不付款的情况比较少，再加上卖家对秒杀商品的库存有严格限制，所以秒杀商品采用“下单减库存”更加合理。另外，理论上由于“下单减库存”比“预扣库存”以及涉及第三方支付的“付款减库存”在逻辑上更为简单，所以性能上更占优势。</p><p>下单减库存”在数据一致性上，主要就是保证大并发请求时库存数据不能为负数，也就是要保证数据库中的库存字段值不能为负数，一般我们有多种解决方案：一种是在应用程序中通过事务来判断，即保证减后库存不能为负数，否则就回滚；另一种办法是直接设置数据库的字段数据为无符号整数，这样减后库存字段值小于零时会直接执行 SQL 语句来报错；再有一种就是使用 CASE WHEN 判断语句，例如这样的SQL 语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> item <span class="keyword">SET</span> inventory = <span class="keyword">CASE</span> <span class="keyword">WHEN</span> inventory &gt;= xxx <span class="keyword">THEN</span></span><br><span class="line">inventory-xxx <span class="keyword">ELSE</span> inventory <span class="keyword">END</span></span><br></pre></td></tr></table></figure><h2 id="秒杀减库存的极致优化"><a href="#秒杀减库存的极致优化" class="headerlink" title="秒杀减库存的极致优化"></a>秒杀减库存的极致优化</h2><p>由于 MySQL 存储数据的特点，同一数据在数据库里肯定是一行存储（MySQL），因此会有大量线程来竞争 InnoDB 行锁，而并发度越高时等待线程会越多，TPS（TransactionPer Second，即每秒处理的消息数）会下降，响应时间（RT）会上升，数据库的吞吐量就会严重受影响。</p><p>这就可能引发一个问题，就是单个热点商品会影响整个数据库的性能， 导致 0.01% 的商品影响 99.99% 的商品的售卖，这是我们不愿意看到的情况。一个解决思路是遵循前面介绍的原则进行隔离，把热点商品放到单独的热点库中。但是这无疑会带来维护上的麻烦，比如要做热点数据的动态迁移以及单独的数据库等。</p><p>而分离热点商品到单独的数据库还是没有解决并发锁的问题，我们应该怎么办呢？要解决并发锁的问题，有两种办法：</p><ul><li><p>应用层做排队。按照商品维度设置队列顺序执行，这样能减少同一台机器对数据库同一行记录进行操作的并发度，同时也能控制单个商品占用数据库连接的数量，防止热点商品占用太多的数据库连接。</p></li><li><p>数据库层做排队。应用层只能做到单机的排队，但是应用机器数本身很多，这种排队方式控制并发的能力仍然有限，所以如果能在数据库层做全局排队是最理想的。阿里的数据库团队开发了针对这种 MySQL 的 InnoDB 层上的补丁程序（patch），可以在数据库层上对单行记录做到并发排队。</p></li></ul><p>疑惑：排队和锁竞争不都是要等待吗，有啥区别？</p><p>MySQL中，InnoDB 内部的死锁检测，以及 MySQL Server 和InnoDB 的切换会比较消耗性能。<br>淘宝的 MySQL 核心团队还做了很多其他方面的优化，如COMMIT_ON_SUCCESS 和 ROLLBACK_ON_FAIL 的补丁程序，配合在 SQL 里面加提示（hint），在事务里不需要等待应用层提交（COMMIT），而在数据执行完最后一条 SQL后，直接根据 TARGET_AFFECT_ROW 的结果进行提交或回滚，可以减少网络等待时间（平均约 0.7ms）。</p><p>另外，数据更新问题除了前面介绍的热点隔离和排队处理之外，还有些场景（如对商品的lastmodifytime 字段的）更新会非常频繁，在某些场景下这些多条 SQL 是可以合并的，一定时间内只要执行最后一条 SQL 就行了，以便减少对数据库的更新操作。</p><h1 id="准备Plan-B：如何设计兜底方案"><a href="#准备Plan-B：如何设计兜底方案" class="headerlink" title="准备Plan B：如何设计兜底方案?"></a>准备Plan B：如何设计兜底方案?</h1><h2 id="高可用建设应该从哪里着手"><a href="#高可用建设应该从哪里着手" class="headerlink" title="高可用建设应该从哪里着手"></a>高可用建设应该从哪里着手</h2><p>说到系统的高可用建设，它其实是一个系统工程，需要考虑到系统建设的各个阶段，也就是说它其实贯穿了系统建设的整个生命周期：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E9%AB%98%E5%8F%AF%E7%94%A8%E5%BB%BA%E8%AE%BE.png" alt></p><ol><li><p>架构阶段：架构阶段主要考虑系统的可扩展性和容错性，要避免系统出现单点问题。例如多机房单元化部署，即使某个城市的某个机房出现整体故障，仍然不会影响整体网站的运转。</p></li><li><p>编码阶段：编码最重要的是保证代码的健壮性，例如涉及远程调用问题时，要设置合理的超时退出机制，防止被其他系统拖垮，也要对调用的返回结果集有预期，防止返回的结果超出程序处理范围，最常见的做法就是对错误异常进行捕获，对无法预料的错误要有默认处理结果。</p></li><li><p>测试阶段：测试主要是保证测试用例的覆盖度，保证最坏情况发生时，我们也有相应的处理流程。</p></li><li><p>发布阶段：发布时也有一些地方需要注意，因为发布时最容易出现错误，因此要有紧急的回滚机制。</p></li><li><p>运行阶段：运行时是系统的常态，系统大部分时间都会处于运行态，运行态最重要的是对系统的监控要准确及时，发现问题能够准确报警并且报警数据要准确详细，以便于排查问题。</p></li><li><p>故障发生：故障发生时首先最重要的就是及时止损，例如由于程序问题导致商品价格错误，那就要及时下架商品或者关闭购买链接，防止造成重大资产损失。然后就是要能够及时恢复服务，并定位原因解决问题。</p></li></ol><p>为什么系统的高可用建设要放到整个生命周期中全面考虑？<br>因为我们在每个环节中都可能犯错，而有些环节犯的错，你在后面是无法弥补的。例如在架构阶段，你没有消除单点问题，那么系统上线后，遇到突发流量把单点给挂了，你就只能干瞪眼，有时候想加机器都加不进去。所以高可用建设是一个系统工程，必须在每个环节都做好。</p><p>那么针对秒杀系统，我们重点介绍在遇到大流量时，应该从哪些方面来保障系统的稳定运行，所以更多的是看如何针对运行阶段进行处理，这就引出了接下来的内容：降级、限流和拒绝服务。</p><h2 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h2><p>所谓“降级”，就是当系统的容量达到一定程度时，限制或者关闭系统的某些非核心功能，从而把有限的资源保留给更核心的业务。它是一个有目的、有计划的执行过程，所以对降级我们一般需要有一套预案来配合执行。如果我们把它系统化，就可以通过预案系统和开关系统来实现降级。</p><p>降级方案可以这样设计：当秒杀流量达到 5w/s 时，把成交记录的获取从展示 20 条降级到只展示 5 条。“从 20 改到 5”这个操作由一个开关来实现，也就是设置一个能够从开关系统动态获取的系统参数。</p><p><img src="/2021/07/18/interview-seckill-system-design/%E5%BC%80%E5%85%B3%E7%B3%BB%E7%BB%9F.png" alt></p><p>执行降级无疑是在系统性能和用户体验之间选择了前者，降级后肯定会影响一部分用户的体验，例如在双 11 零点时，如果优惠券系统扛不住，可能会临时降级商品详情的优惠信息展示，把有限的系统资源用在保障交易系统正确展示优惠信息上，即保障用户真正下单时的价格是正确的。所以降级的核心目标是牺牲次要的功能和用户体验来保证核心业务流程的稳定，是一个不得已而为之的举措。</p><h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><p>如果说降级是牺牲了一部分次要的功能和用户的体验效果，那么限流就是更极端的一种保护措施了。限流就是当系统容量达到瓶颈时，我们需要通过限制一部分流量来保护系统，并做到既可以人工执行开关，也支持自动化保护的措施。</p><p>总体来说，限流既可以是在客户端限流，也可以是在服务端限流。此外，限流的实现方式既要支持 URL 以及方法级别的限流，也要支持基于QPS 和线程的限流</p><p><img src="/2021/07/18/interview-seckill-system-design/%E9%99%90%E6%B5%81%E7%B3%BB%E7%BB%9F.png" alt></p><ul><li><p>客户端限流，好处可以限制请求的发出，通过减少发出无用请求从而减少对系统的消耗。缺点就是当客户端比较分散时，没法设置合理的限流阈值：如果阈值设的太小，会导致服务端没有达到瓶颈时客户端已经被限制；而如果设的太大，则起不到限制的作用。</p></li><li><p>服务端限流，好处是可以根据服务端的性能设置合理的阈值，而缺点就是被限制的请求都是无效的请求，处理这些无效的请求本身也会消耗服务器资源。</p></li></ul><p>在限流的实现手段上来讲，基于 QPS 和线程数的限流应用最多，最大 QPS 很容易通过压测提前获取，例如我们的系统最高支持 1w QPS 时，可以设置 8000 来进行限流保护。线程数限流在客户端比较有效，例如在远程调用时我们设置连接池的线程数，超出这个并发线程请求，就将线程进行排队或者直接超时丢弃。</p><p>限流无疑会影响用户的正常请求，所以必然会导致一部分用户请求失败，因此在系统处理这种异常时一定要设置超时时间，防止因被限流的请求不能 fast fail（快速失败）而拖垮系统。</p><h2 id="拒绝服务"><a href="#拒绝服务" class="headerlink" title="拒绝服务"></a>拒绝服务</h2><p>如果限流还不能解决问题，最后一招就是直接拒绝服务了。</p><p>当系统负载达到一定阈值时，例如 CPU 使用率达到 90% 或者系统 load 值达到 2*CPU 核数时，系统直接拒绝所有请求，这种方式是最暴力但也最有效的系统保护方式。例如秒杀系统，我们在如下几个环节设计过载保护：</p><ul><li>在最前端的 Nginx 上设置过载保护，当机器负载达到某个值时直接拒绝</li><li>HTTP 请求并返回 503 错误码，在 Java 层同样也可以设计过载保护。</li></ul><p>拒绝服务可以说是一种不得已的兜底方案，用以防止最坏情况发生，防止因把服务器压跨而长时间彻底无法提供服务。像这种系统过载保护虽然在过载时无法提供服务，但是系统仍然可以运作，当负载下降时又很容易恢复，所以每个系统和每个环节都应该设置这个兜底方案，对系统做最坏情况下的保护。</p><h1 id="答疑解惑"><a href="#答疑解惑" class="headerlink" title="答疑解惑"></a>答疑解惑</h1><h2 id="应用层用队列接受请求，然后结果怎么返回？"><a href="#应用层用队列接受请求，然后结果怎么返回？" class="headerlink" title="应用层用队列接受请求，然后结果怎么返回？"></a>应用层用队列接受请求，然后结果怎么返回？</h2><h2 id="静态化的方案中关于-Hash-分组的问题"><a href="#静态化的方案中关于-Hash-分组的问题" class="headerlink" title="静态化的方案中关于 Hash 分组的问题"></a>静态化的方案中关于 Hash 分组的问题</h2><h2 id="如何才能做好动静分离？有哪些方案可选？以及关于-Cache-失效的问题"><a href="#如何才能做好动静分离？有哪些方案可选？以及关于-Cache-失效的问题" class="headerlink" title="如何才能做好动静分离？有哪些方案可选？以及关于 Cache 失效的问题"></a>如何才能做好动静分离？有哪些方案可选？以及关于 Cache 失效的问题</h2><p>首先，咱们要有个共识，有 Cache 的地方就必然存在失效问题。为啥要失效？因为要保证<br>数据的一致性。所以要用到 Cache 必然会问如何保证 Cache 和 DB 的数据一致性，如果<br>Cache 有分组的话，还要保证一个分组中多个实例之间数据的一致性，就像保证 MySQL<br>的主从一致一样。</p><p>其实，失效有主动失效和被动失效两种方式。</p><p>被动失效，主要处理如模板变更和一些对时效性不太敏感数据的失效，采用设置一定时间长度（如只缓存 3 秒钟）这种自动失效的方式。当然，你也要开发一个后台管理界面，以便能够在紧急情况下手工失效某些 Cache。</p><p>主动失效，一般有 Cache 失效中心监控数据库表变化发送失效请求、系统发布也需要清空 Cache 数据等几种场景。其中失效中心承担了主要的失效功能，这个失效中心的逻辑图如下：</p><p><img src="/2021/07/18/interview-seckill-system-design/%E5%A4%B1%E6%95%88%E4%B8%AD%E5%BF%83.png" alt></p><p>失效中心会监控关键数据表的变更（有个中间件来解析 MySQL 的 binglog，然后发现有Insert、Update、Delete 等操作时，会把变更前的数据以及要变更的数据转成一个消息发送给订阅方），通过这种方式来发送失效请求给 Cache，从而清除 Cache 数据。如果这种失效有失效中心将失效请求发送给每个 CDN 节点上的 Console 机，然后 Console 机来发送失效请求给每台 Cache 机器。</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.zhihu.com/question/54895548/answer/1352510403" target="_blank" rel="noopener">知乎_如何设计秒杀系统？</a><br><a href="https://www.bilibili.com/video/BV1DV411B7Jq" target="_blank" rel="noopener">B站_淘宝秒杀系统怎么设计？</a><br><a href="https://zhuanlan.zhihu.com/p/86017321" target="_blank" rel="noopener">这是我读过写得最好的【秒杀系统架构】分析与实战！</a><br><a href="https://github.com/tyjwan/second-kill-system/blob/main/%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F.md" target="_blank" rel="noopener">github文档_tyjwan_设计一个秒杀系统</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzIwODkzOTc1MQ==&mid=2247483938&idx=1&sn=05c11475c9da399cec711c05782e917f&chksm=977a3daaa00db4bcd7c5d27064bee7fb1f6795b87ef84e7ae198fa4206a85ba17cf1c05a24c5&token=904636431&lang=zh_CN&scene=21#wechat_redirect" target="_blank" rel="noopener">千万级 高并发 “秒杀” 架构设计（含源码）</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzAxODcyNjEzNQ==&mid=2247489300&idx=1&sn=27788b31b4b89146a6dd971bc23238d0&chksm=9bd0ba8caca7339ad915c461399369bd54aa846a6e67ca99e1100f1cf77b1dc000d700ec67dd&scene=21#wechat_redirect" target="_blank" rel="noopener">秒杀架构模型设计</a><br><a href="https://zhuanlan.zhihu.com/p/92307325" target="_blank" rel="noopener">知乎_《进大厂系列》系列-秒杀系统设计</a></p><div id="gitalk-container"></div><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalkConfig={clientID:"9b0e6a8ee9514649c4e7",clientSecret:"93f2b2b36da58f64f4353d6d5b7f6005a9f80d7c",repo:"octopuslian.github.io",owner:"OctopusLian",admin:["OctopusLian"],distractionFreeMode:!1};gitalkConfig.id=md5(location.pathname);var gitalk=new Gitalk(gitalkConfig);gitalk.render("gitalk-container")</script></div><div><div><br><br><div style="text-align:center;color:#ccc;font-size:14px">----------- 本文结束 -----------</div><br><br><br><br></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>金额随意，一元也是鼓励~</div><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechatpay.jpg" alt="Neo Zhang 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/alipay.jpg" alt="Neo Zhang 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> Neo Zhang</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://octopuslian.github.io/2021/07/18/interview-seckill-system-design/" title="如何设计一个秒杀系统">https://octopuslian.github.io/2021/07/18/interview-seckill-system-design/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag"># 系统设计</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag"># 秒杀系统</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/07/17/leetcode-34-find-first-and-last-position-of-element-in-sorted-array/" rel="next" title="LeetCode-34-find-first-and-last-position-of-element-in-sorted-array | 在排序数组中查找元素的第一个和最后一个位置"><i class="fa fa-chevron-left"></i> LeetCode-34-find-first-and-last-position-of-element-in-sorted-array | 在排序数组中查找元素的第一个和最后一个位置</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2021/07/18/geekbang-live-go-basic-sprint-day-1/" rel="prev" title="Go基础冲刺营_Day1_Golang基础语法和Web框架起步">Go基础冲刺营_Day1_Golang基础语法和Web框架起步 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/neozhang.png" alt="Neo Zhang"><p class="site-author-name" itemprop="name">Neo Zhang</p><p class="site-description motion-element" itemprop="description">All is Well.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">260</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">379</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/OctopusLian" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="zoctopus@qq.com" target="_blank" title="QQ-eMail"><i class="fa fa-fw fa-envelope"></i>QQ-eMail</a> </span><span class="links-of-author-item"><a href="https://www.linkedin.com/in/%E5%BF%B5%E5%BF%B5-niannian-zhang-%E5%BC%A0-2a9620173/" target="_blank" title="LinkedIn"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a> </span><span class="links-of-author-item"><a href="https://www.douban.com/people/157937416/" target="_blank" title="Douban"><i class="fa fa-fw fa-douban"></i>Douban</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="www.appleice.net" title="苹果" target="_blank">苹果</a></li><li class="links-of-blogroll-item"><a href="https://blog.caojun.xyz" title="CAOJUN" target="_blank">CAOJUN</a></li><li class="links-of-blogroll-item"><a href="https://seekload.net/" title="Seekload" target="_blank">Seekload</a></li><li class="links-of-blogroll-item"><a href="https://xq99.me/" title="冰水鉴心" target="_blank">冰水鉴心</a></li><li class="links-of-blogroll-item"><a href="https://snowdreams1006.github.io/" title="雪之梦技术驿站" target="_blank">雪之梦技术驿站</a></li><li class="links-of-blogroll-item"><a href="https://blog.thinkeridea.com/" title="戚银" target="_blank">戚银</a></li><li class="links-of-blogroll-item"><a href="https://www.sanphantom.com/" title="浅安" target="_blank">浅安</a></li><li class="links-of-blogroll-item"><a href="http://frankorz.com/" title="萤火之森" target="_blank">萤火之森</a></li><li class="links-of-blogroll-item"><a href="https://aofeisheng.com/" title="Aofei Sheng" target="_blank">Aofei Sheng</a></li><li class="links-of-blogroll-item"><a href="https://qcrao.com" title="码农桃花源" target="_blank">码农桃花源</a></li><li class="links-of-blogroll-item"><a href="https://eddycjy.gitbook.io/golang/" title="跟煎鱼学GO" target="_blank">跟煎鱼学GO</a></li><li class="links-of-blogroll-item"><a href="https://alexinea.com/" title="Alexinea" target="_blank">Alexinea</a></li><li class="links-of-blogroll-item"><a href="https://likeya.me/" title="微观世界" target="_blank">微观世界</a></li><li class="links-of-blogroll-item"><a href="https://zgao.top/" title="zgao" target="_blank">zgao</a></li><li class="links-of-blogroll-item"><a href="https://www.coderboy.cn/" title="素色小镇" target="_blank">素色小镇</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#秒杀系统架构设计都有哪些关键点"><span class="nav-number">1.</span> <span class="nav-text">秒杀系统架构设计都有哪些关键点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设计秒杀系统时应该注意的5个架构原则"><span class="nav-number">2.</span> <span class="nav-text">设计秒杀系统时应该注意的5个架构原则</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#架构原则1-数据要尽量少"><span class="nav-number">2.1.</span> <span class="nav-text">架构原则1. 数据要尽量少</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么“数据要尽量少”呢？"><span class="nav-number">2.1.1.</span> <span class="nav-text">为什么“数据要尽量少”呢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构原则2-请求数要尽量少"><span class="nav-number">2.2.</span> <span class="nav-text">架构原则2. 请求数要尽量少</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构原则3-路径要尽量短"><span class="nav-number">2.3.</span> <span class="nav-text">架构原则3. 路径要尽量短</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构原则4-依赖要尽量少"><span class="nav-number">2.4.</span> <span class="nav-text">架构原则4. 依赖要尽量少</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构原则5-不要有单点"><span class="nav-number">2.5.</span> <span class="nav-text">架构原则5. 不要有单点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何才能做好动静分离？有哪些方案可选？"><span class="nav-number">3.</span> <span class="nav-text">如何才能做好动静分离？有哪些方案可选？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#何为动静数据"><span class="nav-number">3.1.</span> <span class="nav-text">何为动静数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#怎样对静态数据做缓存"><span class="nav-number">3.1.1.</span> <span class="nav-text">怎样对静态数据做缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何做动静分离的改造"><span class="nav-number">3.2.</span> <span class="nav-text">如何做动静分离的改造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动静分离的几种架构方案"><span class="nav-number">3.3.</span> <span class="nav-text">动静分离的几种架构方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案-1：实体机单机部署"><span class="nav-number">3.3.1.</span> <span class="nav-text">方案 1：实体机单机部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案-2：统一-Cache-层"><span class="nav-number">3.3.2.</span> <span class="nav-text">方案 2：统一 Cache 层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案-3：上-CDN"><span class="nav-number">3.3.3.</span> <span class="nav-text">方案 3：上 CDN</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二八原则：有针对性地处理好系统的“热点数据”"><span class="nav-number">4.</span> <span class="nav-text">二八原则：有针对性地处理好系统的“热点数据”</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要关注热点"><span class="nav-number">4.1.</span> <span class="nav-text">为什么要关注热点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是“热点”"><span class="nav-number">4.2.</span> <span class="nav-text">什么是“热点”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发现热点数据"><span class="nav-number">4.3.</span> <span class="nav-text">发现热点数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#处理热点数据"><span class="nav-number">4.4.</span> <span class="nav-text">处理热点数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#优化"><span class="nav-number">4.4.1.</span> <span class="nav-text">优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#限制"><span class="nav-number">4.4.2.</span> <span class="nav-text">限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#隔离"><span class="nav-number">4.4.3.</span> <span class="nav-text">隔离</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#流量削峰这事应该怎么做？"><span class="nav-number">5.</span> <span class="nav-text">流量削峰这事应该怎么做？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要削峰"><span class="nav-number">5.1.</span> <span class="nav-text">为什么要削峰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#排队"><span class="nav-number">5.2.</span> <span class="nav-text">排队</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#答题"><span class="nav-number">5.3.</span> <span class="nav-text">答题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分层过滤"><span class="nav-number">5.4.</span> <span class="nav-text">分层过滤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#影响性能的因素有哪些？又该如何提高系统的性能？"><span class="nav-number">6.</span> <span class="nav-text">影响性能的因素有哪些？又该如何提高系统的性能？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#影响性能的因素"><span class="nav-number">6.1.</span> <span class="nav-text">影响性能的因素</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#响应时间和-QPS"><span class="nav-number">6.1.1.</span> <span class="nav-text">响应时间和 QPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程数对-QPS-的影响"><span class="nav-number">6.1.2.</span> <span class="nav-text">线程数对 QPS 的影响</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何发现瓶颈"><span class="nav-number">6.2.</span> <span class="nav-text">如何发现瓶颈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何优化系统"><span class="nav-number">6.3.</span> <span class="nav-text">如何优化系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#减少编码"><span class="nav-number">6.3.1.</span> <span class="nav-text">减少编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#减少序列化"><span class="nav-number">6.3.2.</span> <span class="nav-text">减少序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-极致优化"><span class="nav-number">6.3.3.</span> <span class="nav-text">Java 极致优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并发读优化"><span class="nav-number">6.3.4.</span> <span class="nav-text">并发读优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#秒杀系统“减库存”设计的核心逻辑"><span class="nav-number">7.</span> <span class="nav-text">秒杀系统“减库存”设计的核心逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#减库存有哪几种方式"><span class="nav-number">7.1.</span> <span class="nav-text">减库存有哪几种方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#减库存可能存在的问题"><span class="nav-number">7.2.</span> <span class="nav-text">减库存可能存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#大型秒杀中如何减库存？"><span class="nav-number">7.3.</span> <span class="nav-text">大型秒杀中如何减库存？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#秒杀减库存的极致优化"><span class="nav-number">7.4.</span> <span class="nav-text">秒杀减库存的极致优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#准备Plan-B：如何设计兜底方案"><span class="nav-number">8.</span> <span class="nav-text">准备Plan B：如何设计兜底方案?</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用建设应该从哪里着手"><span class="nav-number">8.1.</span> <span class="nav-text">高可用建设应该从哪里着手</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#降级"><span class="nav-number">8.2.</span> <span class="nav-text">降级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限流"><span class="nav-number">8.3.</span> <span class="nav-text">限流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拒绝服务"><span class="nav-number">8.4.</span> <span class="nav-text">拒绝服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#答疑解惑"><span class="nav-number">9.</span> <span class="nav-text">答疑解惑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#应用层用队列接受请求，然后结果怎么返回？"><span class="nav-number">9.1.</span> <span class="nav-text">应用层用队列接受请求，然后结果怎么返回？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态化的方案中关于-Hash-分组的问题"><span class="nav-number">9.2.</span> <span class="nav-text">静态化的方案中关于 Hash 分组的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何才能做好动静分离？有哪些方案可选？以及关于-Cache-失效的问题"><span class="nav-number">9.3.</span> <span class="nav-text">如何才能做好动静分离？有哪些方案可选？以及关于 Cache 失效的问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">10.</span> <span class="nav-text">参考链接</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Neo Zhang</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="box",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="box",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html><!-- rebuild by neat -->